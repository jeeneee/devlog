---
title: '[ì¿ ë²„ë„¤í‹°ìŠ¤] ArgoCD & Github Actions CI/CD'
slug: 'argocd-github-actions-ci-cd'
description: 'gitops ê¸°ë°˜ì˜ ArgoCDë¥¼ ì„¤ì¹˜í•˜ê³  Github Actionsë¥¼ ì‚¬ìš©í•´ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•©ë‹ˆë‹¤.'
tags: ["k8s", "infra", "CI/CD"]
pubDate: '2025-05-31'
---
## Intro
[ì´ì „ ê¸€](../metallb-ingress-controller-and-cert-manager/)ì— ì´ì–´ CI/CDë¥¼ êµ¬ì„±í•´ ë´…ì‹œë‹¤.

ì‚¬ìš©í•  ê¸°ìˆ  ìŠ¤íƒì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
- Github Action
- kustomize
- ArgoCD

![cicd](cicd.png "cicd")

## ArgoCD
> ArgoCDë€ ì¿ ë²„ë„¤í‹°ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë°°í¬ë¥¼ Git ì €ì¥ì†Œì˜ ìƒíƒœì— ê¸°ë°˜í•˜ì—¬ ìë™ìœ¼ë¡œ ë™ê¸°í™”í•˜ê³  ê´€ë¦¬í•´ ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

### ArgoCD ì„¤ì¹˜
[ì—¬ëŸ¬ ì„¤ì¹˜ ë°©ë²•](https://argo-cd.readthedocs.io/en/stable/operator-manual/installation/) ì¤‘ì— manifestë¥¼ ì´ìš©í•´ ì„¤ì¹˜í•©ë‹ˆë‹¤.
í•´ë‹¹ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì„¤ì¹˜ ë²„ì „ì„ ì„ íƒí•´ì•¼ í•˜ëŠ”ë°, ì €ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ v1.32ì— ë§ëŠ” v2.14.9ë¥¼ ì„¤ì¹˜í•  ì˜ˆì •ì…ë‹ˆë‹¤.(https://raw.githubusercontent.com/argoproj/argo-cd/v2.14.9/manifests/install.yaml)
íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì¶”ê°€ ë˜ëŠ” ìˆ˜ì •í•©ë‹ˆë‹¤.

ë³´í†µ ê¶Œí•œ, ë°°í¬ ì•Œë¦¼ ë“±ì„ ìˆ˜ì •í•˜ëŠ”ë°, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ github SSOë¥¼ ì„¤ì •í•˜ê² ìŠµë‹ˆë‹¤. github tokenì˜ ê¶Œí•œ ë° ìƒì„± ê³¼ì •ì€ ì°¸ê³ í•  ìë£Œê°€ ë§ì•„ ìƒëµí•©ë‹ˆë‹¤.

- argocd-cm
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
  name: argocd-cm
  namespace: argocd
data:
  admin.enabled: "false"
  dex.config: |
    connectors:
      - type: github
        id: github
        name: GitHub
        config:
          clientID: ${GITHUB_CLIENT_ID}
          clientSecret: ${GITHUB_CLIENT_SECRET}
          loadAllGroups: true
```

- argocd-rbac-cm
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
  name: argocd-rbac-cm
data:
  policy.csv: |
    g, ${GITHUB_ORGANIZATION}, role:admin
```

ì´ì œ í•´ë‹¹ manifestì™€ ingress(ìƒëµ)ë¥¼ ì ìš©í•˜ê³  ì ‘ì†í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ê¹ƒí—™ ë¡œê·¸ì¸ ë²„íŠ¼ë§Œ í™œì„±í™”ë©ë‹ˆë‹¤.
![argocd](argocd.jpg "argocd")

manifest ì„¤ì¹˜ ì‹œ ìƒì„±ë˜ëŠ” ì£¼ìš” pods
- argocd-server: API ì„œë²„ ë° ì›¹ UI ì œê³µ
- argocd-repo-server: git ì €ì¥ì†Œì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ì˜ë¥¼ ê°€ì ¸ì™€ì„œ ìµœì¢… yamlë¡œ ë³€í™˜
- argocd-application-controller: ì •ì˜ëœ ìƒíƒœ(git)ì™€ ì‹¤ì œ ìƒíƒœ(k8s)ë¥¼ ë¹„êµí•˜ê³  ë™ê¸°í™”
- argocd-dex-server: ë¡œê·¸ì¸ ì¸ì¦ì„ ìœ„í•œ OIDC provider
- argocd-redis: ArgoCD ë‚´ë¶€ ìºì‹œ ì €ì¥ì†Œ
- argocd-notification-controller: slack, discord, email ë“±ìœ¼ë¡œ ë°°í¬ ì•Œë¦¼ ì „ì†¡

### k8s cluster ì¶”ê°€
ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ ì¶”ê°€í•˜ê¸° ìœ„í•´ì„  argocd clië¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
[ê³µì‹ ë¬¸ì„œ](https://argo-cd.readthedocs.io/en/stable/cli_installation/)ë¥¼ ì°¸ê³ í•˜ì—¬ argocd clië¥¼ ë¡œì»¬ì— ì„¤ì¹˜í•©ë‹ˆë‹¤.

```shell
argocd login {your domain} --sso
argocd cluster add {your context}

# kube-system namespaceì— ë¦¬ì†ŒìŠ¤ ìƒì„±ì´ ë¶ˆê°€í•œ ê²½ìš° ë³„ë„ì˜ namespace ìƒì„±
kubectl create namespace {another namespace}
argocd cluster add {your context} --system-namespace {another namespace}
```
ì´ì œ argoCD UIì—ì„œ **Settings-Clusters** ë¡œ ê°€ë³´ë©´ í•´ë‹¹ ì»¨í…ìŠ¤íŠ¸ê°€ ì¶”ê°€ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Repositories, Projects ì¶”ê°€
argoCD UIì˜ **Settings-Repositories**ì—ì„œ gitops ë ˆí¬ì§€í† ë¦¬ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤. SSH, HTTPS, GITHUB APP ë“±ì„ í†µí•´ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Settings-Projects**ì—ì„œëŠ” ìœ„ì—ì„œ ì—°ê²°í•œ ë ˆí¬ì§€í† ë¦¬ì™€ í´ëŸ¬ìŠ¤í„°ë¥¼ ì—°ê²°í•œ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### rollouts ì„¤ì¹˜
ArgoCD rolloutsëŠ” ì ì§„ì  ë°°í¬ë¥¼ k8s í™˜ê²½ì—ì„œ ì•ˆì „í•˜ê³  ìë™ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ëŠ” CRDsì…ë‹ˆë‹¤. Canary, Blue-Green ë°°í¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.
ìì„¸í•œ ì„¤ëª…ì€ [Argo Rollouts](https://argoproj.github.io/rollouts/)ë¥¼ ì°¸ê³ í•´ ì£¼ì„¸ìš”.
```shell
kubectl create namespace argo-rollouts
kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/download/v1.8.2/install.yaml
```
ì´ë ‡ê²Œ ArgoCD ì„¤ì¹˜ ë° ì„¤ì •ì€ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤ğŸ¥³

ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ëŠ” CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì„± í›„ì— í•´ë³´ê² ìŠµë‹ˆë‹¤.

## Github Actions
ìµœìƒë‹¨ ì´ë¯¸ì§€ì™€ ê°™ì´ Github actions + ArgoCDë¥¼ í†µí•´ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•˜ê³  spring applciationì„ blue-green ë°©ì‹ìœ¼ë¡œ ë°°í¬í•´ ë³´ê² ìŠµë‹ˆë‹¤.

### ì„œë¹„ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜
Dockerfileì´ ì•„ë‹Œ jibë¡œ OCI ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ê²ƒì´ë¯€ë¡œ build.gradle.kts ì— ì•„ë˜ì™€ ê°™ì´ ì •ì˜í•©ë‹ˆë‹¤.
```kotlin
plugins {
    id("com.google.cloud.tools.jib") version "3.4.5"
}

dependencies {
    implementation("org.springframework.boot:spring-boot-starter-web")
    implementation("org.springframework.boot:spring-boot-starter-actuator") // health check
}

jib {
    val username = project.findProperty("username").toString()
    val password = project.findProperty("password").toString()
    val image = project.findProperty("image").toString()
    val tag = project.findProperty("tag").toString()

    from {
        this.image = "eclipse-temurin:21-jre-jammy"
        platforms {
            platform {
                architecture = "arm64"
                os = "linux"
            }
        }
    }

    to {
        this.image = image
        this.tags = setOf(tag)
        auth {
            this.username = username
            this.password = password
        }
    }

    container {
        format = com.google.cloud.tools.jib.api.buildplan.ImageFormat.OCI
        ports = listOf("8080")
        workingDirectory = "/app"
    }
}
```

.github/workflows í•˜ìœ„ ë””ë ‰í† ë¦¬ì— ì›Œí¬í”Œë¡œìš° yaml íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
```yaml
name: CI/CD dev

on:
  push:
    branches: ["develop"]

env:
  PHASE: dev
  REGISTRY_TAG: dev-${{ github.run_number }}-${{ github.run_attempt }}
  REGISTRY_IMAGE: ghcr.io/${{ github.repository }} # github registry

jobs:
  build-api:
    runs-on: ubuntu-latest
    env:
      SERVICE_NAME: ${{ github.event.repository.name }} # demo-spring-cicd
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Gradle jib # github repository Settings-Actions secrets and variables-Repository secrets ë“±ë¡
        run: ./gradlew jib -P username=${{ secrets.REGISTRY_USERNAME }} -P password=${{ secrets.REGISTRY_PASSWORD }} -P image=${{ env.REGISTRY_IMAGE }} -P tag=${{ env.REGISTRY_TAG }}

      - name: Setup Kustomize # shell scriptì—ì„œ ì‚¬ìš©í•  kustomize íˆ´ ì„¤ì •
        uses: imranismail/setup-kustomize@v2

      - name: Checkout Gitops Repository # gitops ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/gitops
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          path: gitops

      - name: Execute Shell Script # ì…¸ ìŠ¤í¬ë¦½íŠ¸ì— ì„¸ ê°œ ì¸ì ì „ë‹¬í•˜ì—¬ ì‹¤í–‰(kustomizeë¡œ ì´ë¯¸ì§€ íƒœê·¸ ë³€ê²½)
        run: |
          ./gitops/.github-actions/deploy.sh ${{ env.SERVICE_NAME }} ${{ env.PHASE }} ${{ env.REGISTRY_IMAGE }}:${{ env.REGISTRY_TAG }}

      - name: Git Commit & Push # íƒœê·¸ ìˆ˜ì • ë°˜ì˜í•˜ì—¬ ì»¤ë°‹ í‘¸ì‹œ
        run: |
          cd gitops
          git config user.name "GITHUB_ACTION"
          git config user.email "github-action@github.com"
          git commit -am "updated by GITHUB_ACTION(${{ env.SERVICE_NAME }}:${{ env.REGISTRY_TAG }})"
          git push -u origin main
```

### gitops
#### í”„ë¡œì íŠ¸ êµ¬ì¡°
```text
.
â”œâ”€â”€ .github-actions
â”‚Â Â  â””â”€â”€ deploy.sh
â””â”€â”€ service
    â”œâ”€â”€ demo-spring-cicd
    â”‚Â Â  â”œâ”€â”€ base
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ rollout.yaml
    â”‚Â Â  â”‚Â Â  â””â”€â”€ service.yaml
    â”‚Â Â  â””â”€â”€ overlays
    â”‚Â Â      â””â”€â”€ dev
    â”‚Â Â          â”œâ”€â”€ ingress.yaml
    â”‚Â Â          â””â”€â”€ kustomization.yaml
```

#### deploy.sh
ìƒë‹¨ github actions workflow ë‚´ ì…¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
ì¸ìë¥¼ í†µí•´ í•´ë‹¹ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
```shell
#!/usr/bin/env bash

set -e

SERVICE_NAME="$1"
PHASE="$2"
IMAGE_URL="$3"

if [[ -z "$SERVICE_NAME" || -z "$PHASE" || -z "$IMAGE_URL" ]]; then
  echo "Usage: $0 <service-name> <phase> <image-url>"
  exit 1
fi

CURRENT_PATH="$(cd "$(dirname "$0")" && pwd)"

cd "$CURRENT_PATH/../service/$SERVICE_NAME/overlays/$PHASE" || exit 1

echo "Deploy PHASE: $PHASE"
echo "Working directory: $(pwd)"
echo "Setting image to: $IMAGE_URL"

kustomize edit set image "$IMAGE_URL"
```

#### base/kustomization.yaml
kustomizeë¥¼ í†µí•´ ìƒìœ„ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ê³µí†µ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - rollout.yaml
  - service.yaml
```

#### base/rollout.yaml
Argo Rolloutsë¥¼ ì´ìš©í•œ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì „ëµì„ ì •ì˜í•œ manifestì…ë‹ˆë‹¤.
readiness/liveness probe, ë¦¬ì†ŒìŠ¤ ì œí•œ, ë°°í¬ ì „ëµ ë“±ì„ í¬í•¨í•©ë‹ˆë‹¤.
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: demo-spring-cicd
spec:
  replicas: 1
  revisionHistoryLimit: 3
  rollbackWindow:
    revisions: 3
  progressDeadlineSeconds: 300
  selector:
    matchLabels:
      app: demo-spring-cicd
  template:
    metadata:
      labels:
        app: demo-spring-cicd
    spec:
      imagePullSecrets:
        - name: ghcr-secret # docker-registry secretì„ ë¯¸ë¦¬ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤
      containers:
        - name: demo-spring-cicd
          image: ghcr.io/code-b-dev/demo-spring-cicd:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 30
            successThreshold: 1
            failureThreshold: 3
            timeoutSeconds: 2
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 30
            successThreshold: 1
            failureThreshold: 3
            timeoutSeconds: 2
          resources:
            requests:
              memory: 2G
              cpu: 1
            limits:
              memory: 2G
              cpu: 1
      dnsPolicy: ClusterFirst
      restartPolicy: Always
  strategy:
    blueGreen: # blue-green ë°°í¬ ì „ëµ
      activeService: demo-spring-cicd
      autoPromotionEnabled: true
```

#### /base/service.yaml
ClusterIP íƒ€ì…ì˜ ì„œë¹„ìŠ¤
```yaml
apiVersion: v1
kind: Service
metadata:
  name: demo-spring-cicd
  namespace: backend
  labels:
    app: demo-spring-cicd
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app: demo-spring-cicd
```

#### /overlays/dev/ingress.yaml
TLS ì„¤ì •ì„ í¬í•¨í•œ ì¸ê·¸ë ˆìŠ¤
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: demo-spring-cicd
  namespace: backend
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: {host}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: demo-spring-cicd
                port:
                  name: http
  tls:
    - secretName: demo-spring-cicd-tls
      hosts:
        - cicd.xxx.xxx
```

#### /overlays/dev/kustomization.yaml
dev í™˜ê²½ ì˜¤ë²„ë ˆì´ ì„¤ì •. baseë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ë¦¬ì†ŒìŠ¤ ì œí•œ ë“±ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: backend

resources:
- ../../base
- ingress.yaml

images:
- name: ghcr.io/code-b-dev/demo-spring-cicd
  newTag: dev-1-1

patches:
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 2G
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 1
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 2G
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1
  target: # patch target
    kind: Rollout
    name: demo-spring-cicd
```

## ë°°í¬
gitops ì½”ë“œ ë°˜ì˜ë„ ëë‚¬ìœ¼ë‹ˆ ì´ì œ ArgoCDì— Applicationì„ ì¶”ê°€í•˜ì—¬ ë°°í¬í•´ ë³´ê² ìŠµë‹ˆë‹¤.
<mark>NEW APP</mark> ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ì•„ë˜ì™€ ê°™ì´ ë‚´ìš©ì„ ì±„ì›Œì¤ë‹ˆë‹¤.

![argocd_application](argocd_application.jpeg "argocd_application")

ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìƒì„±í•˜ë©´ ê´€ë ¨ëœ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![argocd_application_detail](argocd_application_detail.jpg "argocd_application_detail")

ë°°í¬ í›„ ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘” api pathë¡œ ì ‘ì†í•˜ë©´

![hello_world1](hello_world1.png)

ì´ì œ CI/CD íŒŒì´í”„ë¼ì¸ì´ ì˜ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ develop ë¸Œëœì¹˜ì— ìƒˆ ì»¤ë°‹ì„ pushí•˜ê³  ì ‘ì†í•˜ë©´ ë³€ê²½ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤~

![hello_world2](hello_world2.png)
