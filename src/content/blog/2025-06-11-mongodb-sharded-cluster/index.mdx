---
title: '[MongoDB] Sharded Cluster'
slug: 'mongodb-sharded-cluster'
description: 'MongoDB Sharded Clusterì— ëŒ€í•´ ì•Œì•„ë³´ê³  ë¡œì»¬ì— êµ¬ì¶•í•´ ë´…ë‹ˆë‹¤.'
tags: ["mongoDB", "docker", "infra"]
pubDate: '2025-06-11'
---
í˜„ì¬ ì €í¬ íŒ€ì€ MongoDB Sharded Clusterë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©°, ëª¨ë“  íŒ€ì›ì´ ìš´ì˜ í™˜ê²½ê³¼ ìœ ì‚¬í•œ ë¡œì»¬ ê°œë°œ í™˜ê²½ì„ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡
Docker Composeë¥¼ í™œìš©í•´ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í™˜ê²½ì„ êµ¬ì¶•í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ë”¸ê¹ í•˜ë‚˜ë¡œ ë¹ ë¥´ê²Œ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ê¸°ì— 1) ëª…ë ¹ì–´ëŠ” ìŠ¤í¬ë¦½íŠ¸í™”í•˜ê³ , 2) ì•„í‚¤í…ì²˜ëŠ” ìµœëŒ€í•œ ë‹¨ìˆœí™”í•˜ì—¬ ì‚¬ìš© ì¤‘ì— ìˆìŠµë‹ˆë‹¤.

MongoDB Sharded Clusterì— ëŒ€í•´ ì–•ê²Œ ì•Œì•„ë³´ê³ , ì ë‹¹í•œ ì‚¬ì´ì¦ˆë¡œ ë¡œì»¬ì— êµ¬ì¶•í•´ ë´…ë‹ˆë‹¤.

> ì—¬ê¸°ì„œ êµ¬ì¶•í•  ìƒ¤ë“œ í´ëŸ¬ìŠ¤í„°ëŠ” ìš´ì˜, ë¡œì»¬ ëª¨ë‘ ì í•©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ìš´ì˜ì€ config server replicaset ì¶”ê°€, ë¡œì»¬ì€ shard ì¶•ì†Œ í•„ìš”)

## êµ¬ì„± ìš”ì†Œ
MongoDB Sharded ClusterëŠ” 3ê°œì˜ ì»´í¬ë„ŒíŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
1. **shard**: ë°ì´í„° ì €ì¥
    - í•˜ë‚˜ì˜ ìƒ¤ë“œëŠ” primary + í•˜ë‚˜ ì´ìƒì˜ secondaryë¡œ êµ¬ì„±ëœ replicaset
    - ë°ì´í„°ë¥¼ ìƒ¤ë”© í‚¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—¬ëŸ¬ ìƒ¤ë“œì— ë¶„ì‚° ì €ì¥
    - ìƒ¤ë“œ ê°„ ì„œë¡œ ë…ë¦½ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì €ì¥
    - ë°ì´í„° ì–‘ì´ ë§ì•„ì§€ë©´ ìƒ¤ë“œë¥¼ ì¶”ê°€í•´ ìˆ˜í‰ í™•ì¥ ê°€ëŠ¥
2. **config server**: í´ëŸ¬ìŠ¤í„° ë©”íƒ€ë°ì´í„° ì €ì¥
    - í´ëŸ¬ìŠ¤í„° ë‚´ shard ì •ë³´, chunk(ë°ì´í„° ì¡°ê°) ìœ„ì¹˜, ë¶„ì‚° ìƒíƒœ, ë°¸ëŸ°ì‹± ìƒíƒœ ë“±ì„ ì €ì¥
    - ìš´ì˜ í™˜ê²½ì—ì„  ìµœì†Œ 3ê°œì˜ Replica Set ê¶Œì¥
    - ì¥ì•  ì‹œ í´ëŸ¬ìŠ¤í„° ì „ì²´ ë™ì‘ ë¶ˆê°€
3. **mongos**: ì¿¼ë¦¬ ë¼ìš°í„°
    - í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì ì ˆí•œ ìƒ¤ë“œë¡œ ë¼ìš°íŒ…
    - ìì²´ ë°ì´í„° ì €ì¥ x, ë¼ìš°íŒ… ì§‘ê³„ ì—­í•  ì „ë‹´

ì¶”ê°€ë¡œ, Replica Set êµ¬ì„±ì—ì„œë§Œ ì‚¬ìš©ë˜ëŠ” íŠ¹ë³„í•œ ë…¸ë“œ ìœ í˜•ì¸ Arbiterê°€ ìˆìŠµë‹ˆë‹¤.
    - ë¹„ìš© ë“±ì˜ ì´ìœ ë¡œ shard ë©¤ë²„ë¥¼ ë‘ ê°œ ì‚¬ìš©í•  ë•Œ ê³¼ë°˜ìˆ˜ íˆ¬í‘œë¥¼ ìœ„í•œ íˆ¬í‘œê¶Œ í–‰ì‚¬
    - Replica Set êµ¬ì„± ë°©ë²•
        - PSS: Primary, Secondary, Secondary
        - PSA: Primary, Secondary, Arbiter

## Getting Started
ì´ì œ docker composeë¡œ PSS êµ¬ì¡°ì˜ sharded clusterë¥¼ êµ¬ì¶•í•´ ë´…ì‹œë‹¤.

[github code](https://github.com/jeeneee/playground/tree/main/mongo-lab/localenvs)

### Hierarchy
```
.
â”œâ”€â”€ docker-compose.yaml
â””â”€â”€ mongo
    â”œâ”€â”€ init.sh # ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” mongosì—ì„œ ì‹¤í–‰í•˜ëŠ” ì…¸ ìŠ¤í¬ë¦½íŠ¸
    â””â”€â”€ scripts
        â”œâ”€â”€ add-shards.js   # ìƒ¤ë“œ ì¶”ê°€
        â”œâ”€â”€ init-config.js  # config server ì´ˆê¸°í™”
        â”œâ”€â”€ init-db.js      # db ì´ˆê¸°í™”
        â”œâ”€â”€ init-shard1.js  # shard1 ì´ˆê¸°í™”
        â””â”€â”€ init-shard2.js  # shard2 ì´ˆê¸°í™”
```

### docker-compose.yaml
```yaml
services:
  mongo-configsvr1:
    image: mongo:7.0.15
    container_name: mongo-configsvr1
    command: --replSet configReplSet --configsvr --port 27017
    volumes:
      - ${HOME}/playground/mongo/data/configdb:/data/configdb

  mongo-shard1-1:
    image: mongo:7.0.15
    container_name: mongo-shard1-1
    command: --replSet shard1ReplSet --shardsvr --port 27017
    volumes:
      - ${HOME}/playground/mongo/data/shard1-1:/data/db

  mongo-shard1-2:
    image: mongo:7.0.15
    container_name: mongo-shard1-2
    command: --replSet shard1ReplSet --shardsvr --port 27017
    volumes:
      - ${HOME}/playground/mongo/data/shard1-2:/data/db

  mongo-shard1-3:
    image: mongo:7.0.15
    container_name: mongo-shard1-3
    command: --replSet shard1ReplSet --shardsvr --port 27017
    volumes:
      - ${HOME}/playground/mongo/data/shard1-3:/data/db

  mongo-shard2-1:
    image: mongo:7.0.15
    container_name: mongo-shard2-1
    command: --replSet shard2ReplSet --shardsvr --port 27017
    volumes:
      - ${HOME}/playground/mongo/data/shard2-1:/data/db

  mongo-shard2-2:
    image: mongo:7.0.15
    container_name: mongo-shard2-2
    command: --replSet shard2ReplSet --shardsvr --port 27017
    volumes:
      - ${HOME}/playground/mongo/data/shard2-2:/data/db

  mongo-shard2-3:
    image: mongo:7.0.15
    container_name: mongo-shard2-3
    command: --replSet shard2ReplSet --shardsvr --port 27017
    volumes:
      - ${HOME}/playground/mongo/data/shard2-3:/data/db

  mongo-mongos:
    image: mongo:7.0.15
    container_name: mongo-mongos
    entrypoint: [ "bash", "/init.sh" ]
    volumes:
      - ./mongo/init.sh:/init.sh
      - ./mongo/scripts:/scripts
    ports:
      - "27017:27017"
    depends_on:
      - mongo-configsvr1
      - mongo-shard1-1
      - mongo-shard1-2
      - mongo-shard1-3
      - mongo-shard2-1
      - mongo-shard2-2
      - mongo-shard2-3
```

### init.sh
config -> shard1 -> shard2 -> mongos ìˆœìœ¼ë¡œ ì´ˆê¸°í™” ë° ì„¤ì •í•©ë‹ˆë‹¤.
```shell
#!/bin/bash
set -e

function wait_for_mongo() { # mongo component ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜
  local name=$1
  local host=$2
  local port=$3
  echo "â³ Waiting for $name ($host:$port)..."
  until mongosh --host "$host" --port "$port" --eval "db.adminCommand('ping')" >/dev/null 2>&1; do
    sleep 1
  done
  echo "âœ… $name is ready!"
}

# config
wait_for_mongo "mongo-configsvr1" mongo-configsvr1 27017
mongosh --host mongo-configsvr1 --port 27017 /scripts/init-config.js

# shard1
wait_for_mongo "mongo-shard1-1" mongo-shard1-1 27017
wait_for_mongo "mongo-shard1-2" mongo-shard1-2 27017
wait_for_mongo "mongo-shard1-3" mongo-shard1-3 27017
mongosh --host mongo-shard1-1 --port 27017 /scripts/init-shard1.js

# shard2
wait_for_mongo "mongo-shard2-1" mongo-shard2-1 27017
wait_for_mongo "mongo-shard2-2" mongo-shard2-2 27017
wait_for_mongo "mongo-shard2-3" mongo-shard2-3 27017
mongosh --host mongo-shard2-1 --port 27017 /scripts/init-shard2.js

# mongos
echo "ğŸš€ Starting mongo-mongos..."
mongos --configdb configReplSet/mongo-configsvr1:27017 --bind_ip_all & # background ì‹¤í–‰ í›„ pid íšë“
MONGOS_PID=$!

wait_for_mongo "mongo-mongos" localhost 27017

mongosh --host localhost --port 27017 /scripts/add-shards.js  # ìƒ¤ë“œ ì¶”ê°€

mongosh --host localhost --port 27017 /scripts/init-db.js     # db ì´ˆê¸°í™”

wait $MONGOS_PID # mongos ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ì§€ ì•Šë„ë¡ wait
```

### init-config.js
config serverì˜ replica set ì´ˆê¸°í™”
```js
try {
    rs.initiate({
        _id: "configReplSet",
        configsvr: true,
        members: [{ _id: 0, host: "mongo-configsvr1:27017" }]
    })
    print("âœ… Config server replica set initiated.")
} catch (e) {
    print("âš ï¸ Config server already initiated or error: " + e.message)
}
```

### init-shard1.js
shard1ì˜ replica set ì´ˆê¸°í™”
```js
try {
    rs.initiate({
        _id: "shard1ReplSet",
        members: [
            { _id: 0, host: "mongo-shard1-1:27017" },
            { _id: 1, host: "mongo-shard1-2:27017" },
            { _id: 2, host: "mongo-shard1-3:27017" }
        ]
    })
    print("âœ… Shard1 replica set initiated.")
} catch (e) {
    print("âš ï¸ Shard1 already initiated or error: " + e.message)
}
```

### init-shard2.js
shard2ì˜ replica set ì´ˆê¸°í™”
```js
try {
    rs.initiate({
        _id: "shard2ReplSet",
        members: [
            { _id: 0, host: "mongo-shard2-1:27017" },
            { _id: 1, host: "mongo-shard2-2:27017" },
            { _id: 2, host: "mongo-shard2-3:27017" }
        ]
    })
    print("âœ… Shard2 replica set initiated.")
} catch (e) {
    print("âš ï¸ Shard2 already initiated or error: " + e.message)
}
```

### add-shards.js
ìœ„ì—ì„œ ì´ˆê¸°í™”í•œ ë‘ ìƒ¤ë“œë¥¼ ì¶”ê°€
```js
try {
    sh.addShard("shard1ReplSet/mongo-shard1-1:27017,mongo-shard1-2:27017,mongo-shard1-3:27017")
    sh.addShard("shard2ReplSet/mongo-shard2-1:27017,mongo-shard2-2:27017,mongo-shard2-3:27017")
    print("âœ… Shards added to cluster.")
} catch (e) {
    print("âš ï¸ Error adding shards: " + e.message)
}
```

### init-db.js
db ì´ˆê¸°í™” ì˜ˆì‹œ. ëŒ€í™”, ë©”ì‹œì§€ ì»¬ë ‰ì…˜ì„ ìƒì„±í•˜ì˜€ê³ , ë©”ì‹œì§€ ì»¬ë ‰ì…˜ì„ ìƒ¤ë”©í•˜ì˜€ìŠµë‹ˆë‹¤.
```js
const chat = db.getSiblingDB("chat");

chat.createCollection("conversations");
chat.createCollection("messages");

chat.messages.createIndex({ conversationId: "hashed", _id: 1 }, { name: "ix_shardkey" });

const admin = db.getSiblingDB("admin");

try {
    admin.runCommand({ enableSharding: "chat" });
    admin.runCommand({
        shardCollection: "chat.messages",
        key: { conversationId: "hashed", _id: 1 }
    });
    print("âœ… Sharding enabled and shard key applied");
} catch (e) {
    print("âŒ Error during sharding setup: " + e.message);
}
```

## ì‹¤í–‰ ë° ì—°ê²°
```shell
docker compose -f docker-compose.yaml up -d # í´ëŸ¬ìŠ¤í„° ì‹¤í–‰
docker logs -f mongo-mongos # í´ëŸ¬ìŠ¤í„° êµ¬ì„± ë¡œê·¸ í™•ì¸
docker exec mongo-mongos mongosh --eval "sh.status()" # ìƒ¤ë”© ìƒíƒœ í™•ì¸
```
ìƒ¤ë”©ê³¼ ê´€ë ¨ëœ ì •ë³´ë¥¼ ì‘ë‹µí•©ë‹ˆë‹¤. <mark>ì£¼ì„ í™•ì¸</mark>

```
...
shards
[
  {
    _id: 'shard1ReplSet',
    host: 'shard1ReplSet/mongo-shard1-1:27017,mongo-shard1-2:27017,mongo-shard1-3:27017', // ìƒ¤ë“œ êµ¬ì„±ì›
    state: 1, // ì •ìƒ
    topologyTime: Timestamp({ t: 1749618586, i: 8 }) // í† í´ë¡œì§€ ê°±ì‹  ì‹œê°
  },
  {
    _id: 'shard2ReplSet',
    host: 'shard2ReplSet/mongo-shard2-1:27017,mongo-shard2-2:27017,mongo-shard2-3:27017',
    state: 1,
    topologyTime: Timestamp({ t: 1749618586, i: 12 })
  }
]
---
autosplit // íŠ¹ì • chunk sizeê°€ ê¸°ì¤€ ì´ìƒìœ¼ë¡œ ì»¤ì§€ë©´ ìë™ ë¶„í• 
{ 'Currently enabled': 'yes' }
---
balancer // ìƒ¤ë“œ ê°„ ê· í˜• ìœ ì§€(chunk ì¬ë°°ì¹˜)
{
  'Currently enabled': 'yes',
  'Currently running': 'no',
  'Failed balancer rounds in last 5 attempts': 0,
  'Migration Results for the last 24 hours': 'No recent migrations'
}
---
databases
[
  {
    database: {
      _id: 'chat',
      primary: 'shard1ReplSet',
      partitioned: false, // DB ë‹¨ìœ„ ìƒ¤ë”© x, collection ë‹¨ìœ„ ìƒ¤ë”©
      version: {
        uuid: UUID('ea08151a-206e-4b43-a135-9b9bc7f82d15'),
        timestamp: Timestamp({ t: 1749618586, i: 24 }),
        lastMod: 1
      }
    },
    collections: {
      'chat.messages': {
        shardKey: { conversationId: 'hashed', _id: 1 },
        unique: false,
        balancing: true,
        chunkMetadata: [
          { shard: 'shard1ReplSet', nChunks: 2 }, // shard1ì— 2ê°œì˜ chunk ì¡´ì¬
          { shard: 'shard2ReplSet', nChunks: 2 } // shard2ì— 2ê°œì˜ chunk ì¡´ì¬
        ],
        chunks: [ // ì‹¤ì œ chunk ì •ë³´, shard key ë²”ìœ„ ê¸°ë°˜ìœ¼ë¡œ ìª¼ê°œì§„ ë°ì´í„° ë²”ìœ„ë“¤
          { min: { conversationId: MinKey(), _id: MinKey() }, max: { conversationId: Long('-4611686018427387902'), _id: MinKey() }, 'on shard': 'shard2ReplSet', 'last modified': Timestamp({ t: 1, i: 0 }) },
          { min: { conversationId: Long('-4611686018427387902'), _id: MinKey() }, max: { conversationId: Long('0'), _id: MinKey() }, 'on shard': 'shard2ReplSet', 'last modified': Timestamp({ t: 1, i: 1 }) },
          { min: { conversationId: Long('0'), _id: MinKey() }, max: { conversationId: Long('4611686018427387902'), _id: MinKey() }, 'on shard': 'shard1ReplSet', 'last modified': Timestamp({ t: 1, i: 2 }) },
          { min: { conversationId: Long('4611686018427387902'), _id: MinKey() }, max: { conversationId: MaxKey(), _id: MaxKey() }, 'on shard': 'shard1ReplSet', 'last modified': Timestamp({ t: 1, i: 3 }) }
        ],
        tags: []
      }
    }
  },
  ...
]
```
ì´ì œ `mongodb://localhost:27017/chat` urië¡œ ì—°ê²° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—°ê²° í›„ì— ë©”ì‹œì§€ ë°ì´í„° ì„¸ ê°œë¥¼ ë„£ê³ , ì•„ë˜ì™€ ê°™ì´ ê° ìƒ¤ë“œì—ì„œ ì¡°íšŒë¥¼ í•´ë´¤ìŠµë‹ˆë‹¤.
```shell
docker exec mongo-shard1-1 mongosh --eval "db.getSiblingDB('chat').messages.find()" # ì¡°íšŒ ê²°ê³¼ 1ê°œ
docker exec mongo-shard2-1 mongosh --eval "db.getSiblingDB('chat').messages.find()" # ì¡°íšŒ ê²°ê³¼ 2ê°œ
```
ìŠ¤í”„ë§ìœ¼ë¡œ êµ¬í˜„í•œ ì½”ë“œëŠ” [mongo-lab](https://github.com/jeeneee/playground/tree/main/mongo-lab)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
